<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insurance Data Manager</title>
<style>
  body { font-family: Arial; margin: 20px; }
  h2 { margin-bottom: 10px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #aaa; padding: 6px; text-align: left; }
  th { background: #eee; }
  input, select, button { margin: 5px; padding: 6px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<h2>Insurance Management System</h2>

<!-- FORM -->
<form id="policyForm">
  <input name="policyNo" placeholder="Policy No." required>
  <input name="plateNo" placeholder="Plate No." required>
  <input name="policyType" placeholder="Policy Type" required>
  <select name="status" required>
    <option value="">Status</option>
    <option value="Active">Active</option>
    <option value="Expired">Expired</option>
  </select>
  <input name="amount" type="number" placeholder="Amount" required>
  <select name="paidUnpaid" required>
    <option value="">Paid/Unpaid</option>
    <option value="Paid">Paid</option>
    <option value="Unpaid">Unpaid</option>
  </select>
  <button type="submit">Add / Update</button>
</form>

<!-- SEARCH -->
<h3>Search / Filter</h3>
<input id="searchInput" placeholder="Search Policy / Plate / Type">
<select id="filterStatus">
  <option value="">All</option>
  <option value="Paid">Paid</option>
  <option value="Unpaid">Unpaid</option>
</select>
<button onclick="loadData()">Apply</button>

<!-- BULK UPLOAD -->
<h3>Bulk Upload (Excel)</h3>
<input type="file" id="excelFile" accept=".xlsx,.xls">
<button onclick="uploadExcel()">Preview</button>
<table id="previewTable"></table>
<button id="sendBtn" style="display:none" onclick="sendBulk()">Send to Sheet</button>

<!-- DATA TABLE -->
<h3>All Records</h3>
<table id="dataTable">
  <thead>
    <tr>
      <th>S/No</th><th>Issue Date</th><th>Policy No.</th>
      <th>Plate No.</th><th>Policy Type</th><th>Status</th>
      <th>Amount</th><th>Paid/Unpaid</th><th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbx8mJ8Y-plEN7goGPugtx19tSyjq0s3q2brBqIUFvj2L1hNJ8a0AYT1M7Vl7cbHLr8/exec";
let bulkRecords = [];

// Add record
document.getElementById('policyForm').addEventListener('submit', e => {
  e.preventDefault();
  const f = e.target;
  const data = {
    action: "add",
    policyNo: f.policyNo.value.trim(),
    plateNo: f.plateNo.value.trim(),
    policyType: f.policyType.value.trim(),
    status: f.status.value,
    amount: f.amount.value,
    paidUnpaid: f.paidUnpaid.value
  };
  fetch(scriptURL, { method: "POST", body: JSON.stringify(data) })
    .then(r => r.json())
    .then(res => { alert(res.message); if(res.status==="success"){ f.reset(); loadData(); }});
});

// Load all records
function loadData() {
  fetch(scriptURL)
    .then(r => r.json())
    .then(rows => {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const filter = document.getElementById("filterStatus").value;
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      rows.filter(r =>
        (!filter || r["Paid/Unpaid"] === filter) &&
        (!search || r["Policy No."].toLowerCase().includes(search) ||
                   r["Plate No."].toLowerCase().includes(search) ||
                   r["Policy Type"].toLowerCase().includes(search))
      ).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r["S/No"]}</td>
          <td>${r["Issue Date"]}</td>
          <td>${r["Policy No."]}</td>
          <td>${r["Plate No."]}</td>
          <td>${r["Policy Type"]}</td>
          <td>${r["Status"]}</td>
          <td>${r["Amount"]}</td>
          <td>${r["Paid/Unpaid"]}</td>
          <td>
            <button onclick='deleteRecord("${r["Policy No."]}")'>Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    })
    .catch(err => alert("⚠️ Cannot fetch data: " + err.message));
}

// Delete record
function deleteRecord(policyNo) {
  if (!confirm("Delete this record?")) return;
  fetch(scriptURL, { method: "POST", body: JSON.stringify({ action: "delete", policyNo }) })
    .then(r => r.json())
    .then(res => { alert(res.message); loadData(); });
}

// BULK EXCEL
function uploadExcel() {
  const file = document.getElementById("excelFile").files[0];
  if (!file) return alert("Please select an Excel file");
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "array" });
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
    bulkRecords = json.map(r => ({
      policyNo: r["Policy No."],
      plateNo: r["Plate No."],
      policyType: r["Policy Type"],
      status: r["Status"],
      amount: r["Amount"],
      paidUnpaid: r["Paid/Unpaid"]
    }));
    const table = document.getElementById("previewTable");
    table.innerHTML = "<tr>" + Object.keys(json[0]||{}).map(h=>`<th>${h}</th>`).join("") + "</tr>";
    table.innerHTML += json.map(r => "<tr>" + Object.values(r).map(v=>`<td>${v}</td>`).join("") + "</tr>").join("");
    document.getElementById("sendBtn").style.display = "block";
  };
  reader.readAsArrayBuffer(file);
}

function sendBulk() {
  if (!bulkRecords.length) return alert("No data to upload");
  fetch(scriptURL, { method: "POST", body: JSON.stringify({ action: "bulkAdd", records: bulkRecords }) })
    .then(r => r.json())
    .then(res => { alert(res.message); loadData(); });
}

window.onload = loadData;
</script>
</body>
</html>

