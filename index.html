<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Insurance Data Manager</title>
  <style>
    body {font-family: Arial; margin: 20px;}
    table {border-collapse: collapse; width: 100%; margin-top: 10px;}
    th, td {border: 1px solid #aaa; padding: 6px; text-align: center;}
    th {background-color: #eee;}
    input, select, button {margin: 4px; padding: 6px;}
    h2, h3 {margin-top: 25px;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Insurance Management System</h2>

  <!-- Add / Update Form -->
  <form id="policyForm">
    <input name="policyNo" placeholder="Policy No." required>
    <input name="plateNo" placeholder="Plate No." required>
    <input name="policyType" placeholder="Policy Type" required>
    <select name="status" required>
      <option value="">Select Status</option>
      <option value="Active">Active</option>
      <option value="Expired">Expired</option>
    </select>
    <input name="amount" type="number" placeholder="Amount" required>
    <select name="paidUnpaid" required>
      <option value="Paid">Paid</option>
      <option value="Unpaid">Unpaid</option>
    </select>
    <button type="submit">Add / Update</button>
  </form>

  <!-- Search / Filter -->
  <h3>Search & Filter</h3>
  <input id="searchInput" placeholder="Search Policy No / Plate No / Type">
  <select id="filterStatus">
    <option value="">All Status</option>
    <option value="Paid">Paid</option>
    <option value="Unpaid">Unpaid</option>
  </select>
  <button onclick="loadData()">Search / Filter</button>

  <!-- Bulk Upload -->
  <h3>Bulk Upload (Excel)</h3>
  <input type="file" id="excelFile" accept=".xlsx,.xls">
  <button onclick="uploadExcel()">Preview Excel</button>
  <table id="previewTable"></table>
  <button id="sendBtn" onclick="sendBulk()" style="display:none;margin-top:5px;">Send to Google Sheet</button>

  <!-- Display Table -->
  <h3>All Records</h3>
  <table id="dataTable">
    <thead>
      <tr>
        <th>S/No</th><th>Issue Date</th><th>Policy No.</th><th>Plate No.</th>
        <th>Policy Type</th><th>Status</th><th>Amount</th><th>Paid/Unpaid</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbx8mJ8Y-plEN7goGPugtx19tSyjq0s3q2brBqIUFvj2L1hNJ8a0AYT1M7Vl7cbHLr8/exec";
    let bulkRecords = [];
    // Add or Update Record
    document.getElementById('policyForm').addEventListener('submit', e => {
      e.preventDefault();
      const f = e.target;
      const data = {
        action: "add",
        policyNo: f.policyNo.value,
        plateNo: f.plateNo.value,
        policyType: f.policyType.value,
        status: f.status.value,
        amount: f.amount.value,
        paidUnpaid: f.paidUnpaid.value
      };

      fetch(scriptURL, { method: 'POST', body: JSON.stringify(data) })
        .then(r => r.json())
        .then(res => {
          alert(res.message);
          if (res.result === "success") {
            f.reset();
            loadData();
          }
        })
        .catch(err => alert("Error: " + err.message));
    });

    // Load Data
    function loadData() {
      fetch(scriptURL)
        .then(r => r.json())
        .then(rows => {
          const search = document.getElementById('searchInput').value.toLowerCase();
          const filter = document.getElementById('filterStatus').value;
          const tbody = document.querySelector('#dataTable tbody');
          tbody.innerHTML = "";

          rows.filter(r =>
            (!filter || r["Paid/Unpaid"] === filter) &&
            (!search ||
             r["Policy No."].toString().toLowerCase().includes(search) ||
             r["Plate No."].toString().toLowerCase().includes(search) ||
             r["Policy Type"].toString().toLowerCase().includes(search))
          ).forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r["S/No"]}</td>
              <td>${cleanDate(r["Issue Date"])}</td>
              <td>${r["Policy No."]}</td>
              <td>${r["Plate No."]}</td>
              <td>${r["Policy Type"]}</td>
              <td>${r["Status"]}</td>
              <td>${r["amount"]}</td>
              <td>${r["Paid/Unpaid"]}</td>
              <td>
                <button onclick='editRecord(${JSON.stringify(r)})'>Edit</button>
                <button onclick='deleteRecord("${r["Policy No."]}")'>Delete</button>
              </td>`;
            tbody.appendChild(tr);
          });
        })
        .catch(err => console.error("Error loading data:", err));
    }

    // Edit
    function editRecord(r) {
      const f = document.getElementById('policyForm');
      f.policyNo.value = r["Policy No."];
      f.plateNo.value = r["Plate No."];
      f.policyType.value = r["Policy Type"];
      f.status.value = r["Status"];
      f.amount.value = r["amount"];
      f.paidUnpaid.value = r["Paid/Unpaid"];
    }

    // Delete
    function deleteRecord(policyNo) {
      if (!confirm("Delete this record?")) return;
      fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({ action: "delete", policyNo })
      })
      .then(r => r.json())
      .then(() => { alert("Deleted!"); loadData(); });
    }

    // Bulk Upload
    function uploadExcel() {
      const file = document.getElementById("excelFile").files[0];
      if (!file) return alert("Please select Excel file first!");
      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        bulkRecords = json.map(r => ({
          policyNo: r["Policy No."],
          plateNo: r["Plate No."],
          policyType: r["Policy Type"],
          status: r["Status"],
          amount: r["amount"],
          paidUnpaid: r["Paid/Unpaid"]
        }));

        const table = document.getElementById("previewTable");
        table.innerHTML = "";
        if (json.length > 0) {
          const headers = Object.keys(json[0]);
          let headerRow = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
          let rows = json.map(row => "<tr>" + headers.map(h => `<td>${row[h]}</td>`).join("") + "</tr>").join("");
          table.innerHTML = headerRow + rows;
          document.getElementById("sendBtn").style.display = "block";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function sendBulk() {
      if (bulkRecords.length === 0) return alert("No records to send!");
      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({ action: "bulkAdd", records: bulkRecords })
      })
      .then(r => r.json())
      .then(() => { alert("Bulk data uploaded!"); loadData(); });
    }

    function cleanDate(dateStr) {
  if (!dateStr) return "";
  // Remove RTL and hidden Unicode marks
  dateStr = dateStr.replace(/[\u200E\u200F]/g, "").trim();
  
  // Try to reformat if it's a recognizable date
  const d = new Date(dateStr);
  if (!isNaN(d)) {
    return d.toLocaleDateString("en-GB"); // "dd/mm/yyyy" format
  }
  return dateStr; // fallback if parsing fails
}

    window.onload = loadData;
  </script>
</body>
</html>







