<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Insurance Data Manager</title>
  <style>
    body {font-family: Arial; margin: 20px;}
    table {border-collapse: collapse; width: 100%;}
    th, td {border: 1px solid #aaa; padding: 5px;}
    th {background-color: #eee;}
    input, select, button {margin: 3px; padding: 5px;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Insurance Management System</h2>

  <!-- Add / Update Form -->
  <form id="policyForm">
    <input name="policyNo" placeholder="Policy No." required>
    <input name="plateNo" placeholder="Plate No." required>
    <input name="policyType" placeholder="Policy Type" required>
    <select name="status" required>
      <option value="">Select Status</option>
      <option value="Active">Active</option>
      <option value="Expired">Expired</option>
    </select>
    <input name="amount" type="number" placeholder="Amount" required>
    <select name="paidUnpaid" required>
      <option value="Paid">Paid</option>
      <option value="Unpaid">Unpaid</option>
    </select>
    <button type="submit">Add / Update</button>
  </form>

  <!-- Search / Filter -->
  <h3>Search & Filter</h3>
  <input id="searchInput" placeholder="Search Policy No / Plate No / Type">
  <select id="filterStatus">
    <option value="">All Status</option>
    <option value="Paid">Paid</option>
    <option value="Unpaid">Unpaid</option>
  </select>
  <button onclick="loadData()">Search / Filter</button>

  <!-- Bulk Upload -->
  <h3>Bulk Upload (Excel)</h3>
  <input type="file" id="excelFile" accept=".xlsx,.xls">
  <button onclick="uploadExcel()">Preview Excel</button>
  <table id="previewTable" style="margin-top:10px;"></table>
  <button id="sendBtn" onclick="sendBulk()" style="display:none;margin-top:5px;">Send to Google Sheet</button>

  <!-- Display Table -->
  <h3>All Records</h3>
  <table id="dataTable">
    <thead>
      <tr>
        <th>S/No</th><th>Issue Date</th><th>Policy No.</th><th>Plate No.</th>
        <th>Policy Type</th><th>Status</th><th>Amount</th><th>Paid/Unpaid</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbww5OlksshFjkcSgjqkV3ssjzZysA1OWghpQkxa56AF4luBoHY2lppK263gQYIX-mXF/exec"; // <-- paste your URL
    let bulkRecords = [];

    // Add or Update Record
    document.getElementById('policyForm').addEventListener('submit', e => {
      e.preventDefault();
      const f = e.target;
      const data = {
        action: "add",
        policyNo: f.policyNo.value,
        plateNo: f.plateNo.value,
        policyType: f.policyType.value,
        status: f.status.value,
        amount: f.amount.value,
        paidUnpaid: f.paidUnpaid.value
      };
      fetch(scriptURL, { method: 'POST', body: JSON.stringify(data) })
        .then(r => r.json()).then(() => { alert("Record saved!"); f.reset(); loadData(); });
    });

    // Load Data
    function loadData() {
      fetch(scriptURL).then(r => r.json()).then(rows => {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filter = document.getElementById('filterStatus').value;
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = "";
        rows.filter(r =>
          (!filter || r["Paid/Unpaid"] === filter) &&
          (!search || r["Policy No."].toLowerCase().includes(search) ||
                     r["Plate No."].toLowerCase().includes(search) ||
                     r["Policy Type"].toLowerCase().includes(search))
        ).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r["S/No"]}</td>
            <td>${r["Issue Date"]}</td>
            <td>${r["Policy No."]}</td>
            <td>${r["Plate No."]}</td>
            <td>${r["Policy Type"]}</td>
            <td>${r["Status"]}</td>
            <td>${r["Amount"]}</td>
            <td>${r["Paid/Unpaid"]}</td>
            <td>
              <button onclick='editRecord(${JSON.stringify(r)})'>Edit</button>
              <button onclick='deleteRecord("${r["Policy No."]}")'>Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function editRecord(r) {
      const f = document.getElementById('policyForm');
      f.policyNo.value = r["Policy No."];
      f.plateNo.value = r["Plate No."];
      f.policyType.value = r["Policy Type"];
      f.status.value = r["Status"];
      f.amount.value = r["Amount"];
      f.paidUnpaid.value = r["Paid/Unpaid"];
    }

    function deleteRecord(policyNo) {
      if (!confirm("Delete this record?")) return;
      fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: "delete", policyNo }) })
        .then(r => r.json()).then(() => { alert("Deleted!"); loadData(); });
    }

    // BULK UPLOAD (Excel)
    function uploadExcel() {
      const file = document.getElementById("excelFile").files[0];
      if (!file) return alert("Please select Excel file first!");
      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        bulkRecords = json.map(r => ({
          policyNo: r["Policy No."],
          plateNo: r["Plate No."],
          policyType: r["Policy Type"],
          status: r["Status"],
          amount: r["Amount"],
          paidUnpaid: r["Paid/Unpaid"]
        }));
        const table = document.getElementById("previewTable");
        table.innerHTML = "";
        if (json.length > 0) {
          const headers = Object.keys(json[0]);
          let headerRow = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
          let rows = json.map(row => "<tr>" + headers.map(h => `<td>${row[h]}</td>`).join("") + "</tr>").join("");
          table.innerHTML = headerRow + rows;
          document.getElementById("sendBtn").style.display = "block";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function sendBulk() {
      if (bulkRecords.length === 0) return alert("No records to send!");
      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({ action: "bulkAdd", records: bulkRecords })
      })
      .then(r => r.json())
      .then(() => { alert("Bulk data uploaded!"); loadData(); });
    }

    window.onload = loadData;
  </script>
</body>
</html>




